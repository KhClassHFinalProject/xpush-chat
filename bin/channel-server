#!/usr/bin/env node

var fs       = require('fs'),
    argv     = require('optimist').argv,
    xpush    = require('../lib/index');
    utils    = require('../lib/utils');

var help = [
    "usage: session-server [options] ",
    "",
    "Starts a xpush server using the specified command-line options",
    "",
    "options:",
    "  --port   PORT       Port that the xpush server should run on",
    "  --config OUTFILE    (mandatory!) Location of the configuration file for the xpush server",
    "  --host   DOMAIN     Hostname",
    "  -h, --help          You're staring at it"
].join('\n');

if (argv.h || argv.help || Object.keys(argv).length === 2 || !argv.config) {
  return console.log(help);
}

var config = {},
    server;

try {
  var data = fs.readFileSync(argv.config);
  config = JSON.parse(data.toString());
} catch (ex) {
  console.error('Error starting xpush server: ' + ex);
  process.exit(1);
}

var options = {};

if(config.zookeeper) options['zookeeper'] = config.zookeeper;
if(config.redis) options['redis'] = config.redis;
if(config.mongodb) options['mongodb'] = config.mongodb;
if(config.sessionServer) {
    options['port'] = config.channelServer.port;
}

if(argv.host) options['host'] = argv.host;
if(argv.port) options['port'] = argv.port;


// process id
console.log(process.pid);
require('child_process').exec('node ' +__dirname+ '/../lib/daemon-xmon',
    {
      env: {
        X_TYPE: 'CHANNEL',
        X_PID: process.pid,
        X_PATH: utils.getBaseDirPath(options['home']),
        X_PORT: options['port']
      }
    },
    function (err, stdout, stderr) {
      if (err) {
        throw err;
      }
      if (stdout) {
        console.log('X-DAEMON : '+ stdout);
      }else if (stderr) {
        console.error('X-DAEMON : '+ stderr);
      }else{
        console.log('X-DAEMON (unknown) : '+ stderr);
      }

    }
);

server = xpush.createChannelServer(options);
